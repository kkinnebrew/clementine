<script type="text/javascript" src="lib/jquery-1.7.2.min.js"></script>
<!--<script type="text/javascript" src="lib/jquery.history.js"></script>-->
<script src="src/commons.js" type="text/javascript"></script>
<script src="src/mvc.js" type="text/javascript"></script>
<!--<script src="src/db.js" type="text/javascript"></script>-->
<script src="src/ui.js" type="text/javascript"></script>
<script src="plugins/ios/ios.js" type="text/javascript"></script>
<script src="plugins/cakephp/cakephp.js" type="text/javascript"></script>
<script src="lib/socket.io.js" type="text/javascript"></script>
<script src="lib/inflection.js" type="text/javascript"></script>
<script src="lib/iscroll.js" type="text/javascript"></script>

<!-- iOS meta rules -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<!-- viewport rules -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">


<link type="text/css" rel="stylesheet" href="plugins/ios/ios.css" />

<style type="text/css">



</style>

<style type="text/css">

html, body {
	font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
	margin: 0;
	padding: 0;
	overflow: hidden;
}

div[data-root=true] {
	display: none;
}

</style>

<script type="text/javascript">

Orange.use('mvc', 'cakephp', 'ui', 'ios', function(O) {

	var Ajax = __import('Ajax'), Model = __import('Model'), ViewController = __import('ViewController');
		
	var source = new O.CakePHP.CakeSource({
		name: 'contacts',
		path: '/contacts/'
	});
	
	var Contact = Model.extend({
	
		getName: function() {
			return 'contact';
		},
		
		getId: function() {
			return 'id';
		},
		
		getFields: function() {
			return {
				contactId: { name: 'id', type: 'key', nullable: false, primaryKey: true },
				firstName: { name: 'first_name', type: 'text', nullable: false },
				lastName: { name: 'last_name', type: 'text', nullable: false },
				email: { name: 'email', type: 'email', nullable: true },
				phone: { name: 'phone', type: 'tel', nullable: true },
				birthday: { name: 'birthday', type: 'date', nullable: true },
				website: { name: 'website', type: 'url', nullable: true }
			}
		},
		
		getSource: function() {
			return source;
		}
	
	});
		
	var MainView = O.iOS.UINavigationViewController.extend({
	
		getType: function() {
			return 'main-view';
		},
		
		getBindings: function() {
			return {
				'first': { 'select': true },
				'second': { 'back': true },
			}
		},
		
		onBack: function(e) {
			this.popToRootView();
		},
		
		onSelect: function(e) {	
			this.getView('second').bindData(e.data);
			this.pushView(this.getView('second'));
		}
	
	});
	
	var FirstView = O.iOS.UIViewController.extend({
		
		getType: function() {
			return 'first-view';
		},
		
		getBindings: function() {
			return {
				'contacts-table': { 'select': true }
			}
		},
		
		onDidLoad: function() {
			
			Contact.getAll({}, Class.proxy(function(data) {
				this.getView('contacts-table').bindData(data);
			}, this), function() {})
		
		},
		
		onSelect: function(e) {
			this.fire('select', e.data);
		}
		
	});
	
	var SecondView = O.iOS.UIViewController.extend({
		
		getType: function() {
			return 'second-view';
		},
		
		getBindings: function() {
			return {
				'back-btn': { 'touchclick': this.onBack }
			}
		},
		
		onBack: function() {
			this.fire('back');
		}
		
	});
		
	var testController = O.Controller.extend({
		
		initialize: function(parent, target) {
		
			// set view statuses
			this.loading = false;
			this.unloading = false;
			this.loaded = false;
			
			this.visible = false;
			this.appearing = false;
			this.disappearing = false;
			
			// create arrays
			this.loadEvts = [];
			this.unloadEvts = [];
			this.showEvts = [];
			this.hideEvts = [];
			
			// setup event target
			this.eventTarget = new O.Events(parent, target);
		
			// run functions
			console.log("Initialized");
		
		},
		
		load: function() {
		
			// return if already loading
			if (this.loading || this.loaded) return;
			
			// set statuses
			this.loading = true;
			
			// bind event handlers
			this.loadEvts.push(this.on('_load', this.onLoad, this));
			this.loadEvts.push(this.on('_loaded', this.onDidLoad, this));
			
			// call onWillLoad
			this.onWillLoad();
		
		},
		
		onWillLoad: function() {
			
			// run functions
			console.log("Will Load");
			
			// fire load event
			this.fire('_load');
			
		},
		
		onLoad: function() {
		
			// run functions
			console.log("Load");
		
			// fire loaded event
			this.fire('_loaded');
		
		},
		
		onDidLoad: function() {
		
			// run functions
			console.log("Did Load");
		
			// unbind all event handlers
			for (var i = 0, len = this.loadEvts.length; i < len; i++) {
				this.loadEvts[i].detach();
			}
			
			// allow unloading
			this.loadEvts = [];
			this.loading = false;
			this.loaded = true;
						
			// fire public load event
			this.fire('load', {'asd': '123'});
		
		},
		
		unload: function() {
		
			// return if already unloading
			if (this.unloading || !this.loaded) return;
			
			// bind event handlers
			this.unloadEvts.push(this.on('_unload', this.onUnload, this));
			this.unloadEvts.push(this.on('_unloaded', this.onDidUnload, this));
			
			// set statuses
			this.unloading = true;
			
			// call onWillUnload
			this.onWillUnload();
		
		},
		
		onWillUnload: function() {
			
			// run functions
			console.log("Will Unload");
			
			// fire unload event
			this.fire('_unload');
			
		},
		
		onUnload: function() {
		
			// run functions
			console.log("Unload");
		
			// fire unloaded event
			this.fire('_unloaded');
		
		},
		
		onDidUnload: function() {
		
			// run functions
			console.log("Did Unload");
			
			// unbind all event handlers
			for (var i = 0, len = this.unloadEvts.length; i < len; i++) {
				this.unloadEvts[i].detach();
			}
			
			// allow loading
			this.unloadEvts = [];
			this.unloading = false;
			this.loaded = false;
			
			// fire public unload event
			this.fire('unload');
		
		},
		
		show: function() {
		
			// return if already visible or appearing
			if (this.visible || this.appearing) return;
			
			// set statuses
			this.appearing = true;
			
			// bind event handlers
			this.showEvts.push(this.on('_appear', this.onAppear, this));
			this.showEvts.push(this.on('_appeared', this.onDidAppear, this));
			
			// call onWillAppear
			this.onWillAppear();
		
		},
		
		onWillAppear: function() {
			
			// run functions
			console.log("Will Appear");
			
			// fire appear event
			this.fire('_appear');
			
		},
		
		onAppear: function() {
		
			// run functions
			console.log("Appear");
		
			// fire appeared event
			this.fire('_appeared');
		
		},
		
		onDidAppear: function() {
		
			// run functions
			console.log("Did Appear");
		
			// unbind all event handlers
			for (var i = 0, len = this.showEvts.length; i < len; i++) {
				this.showEvts[i].detach();
			}
			
			// allow hiding
			this.showEvts = [];
			this.appearing = false;
			this.visible = true;
			
			// fire public appear event
			this.fire('appear');
		
		},
			
		hide: function() {

			// return if already hidden or hiding
			if (!this.visible || this.disappearing) return;
			console.log("hide");
			// set statuses
			this.disappearing = true;
			
			// bind event handlers
			this.hideEvts.push(this.on('_disappear', this.onDisappear, this));
			this.hideEvts.push(this.on('_disappeared', this.onDidDisappear, this));
			
			// call onWillDisappear
			this.onWillDisappear();
		
		},
		
		onWillDisappear: function() {
			
			// run functions
			console.log("Will Disappear");
			
			// fire disappear event
			this.fire('_disappear');
			
		},
		
		onDisappear: function() {
		
			// run functions
			console.log("Disappear");
		
			// fire disappeared event
			this.fire('_disappeared');
		
		},
		
		onDidDisappear: function() {
		
			// run functions
			console.log("Did Disappear");
		
			// unbind all event handlers
			for (var i = 0, len = this.hideEvts.length; i < len; i++) {
				this.hideEvts[i].detach();
			}
			
			// allow showing
			this.hideEvts = [];
			this.disappearing = false;
			this.visible = false;
			
			// fire public disappear event
			this.fire('disappear');
		
		},
		
		on: function(event, callback, context) {
			var proxy = (typeof context !== 'undefined') ? function() { callback.apply(context, arguments); } : callback;
			return this.eventTarget.on.call(this.eventTarget, event, proxy);
		},
		
		detach: function(event, callback) {
			return this.eventTarget.detach.apply(this.eventTarget, arguments);
		},
		
		fire: function(event, data) {
			return this.eventTarget.fire.apply(this.eventTarget, arguments);
		}
	
	});
	
	var t = new testController();
	
	t.on('load', function(e) {
		t.show();
	});
	
	t.on('appear', function(e) {
		t.hide();
	});
	
	t.on('disappear', function(e) {
		t.unload();
	});
	
	t.on('unload', function(e) {
		console.log(t);
	});
	
	
	
	t.load();
	
	
	
	
	
	
	
	
	
	var test = new O.iOS.Application('test', {
		location: true,
		logging: 'INFO',
		poll: false,
		required: ['db', 'mvc', 'ui', 'cakephp', 'ios'],
		version: '1.2.3'
	});
	
	//test.launch();
	

	
//	setTimeout(function() {
//		
//		var myScroll;
//		function loaded() {
//			console.log("!23");
//			myScroll = new iScroll('wrapper');
//		}
//		
//		document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
//		
//		/* * * * * * * *
//		 *
//		 * Use this for high compatibility (iDevice + Android)
//		 *
//		 */
//		loaded();
//		
//	
//	}, 2000);
//	

//function doOnOrientationChange()
//  {
//    switch(window.orientation) 
//    {  
//      case -90:
//      case 90:
//        alert('landscape');
//        break; 
//      default:
//        alert('portrait');
//        break; 
//    }
//  }
//
//  window.onorientationchange = function()
//  {
//    doOnOrientationChange();
//  };
//
  // Initial execution
//  doOnOrientationChange();

});


</script>

<body>

<div id="ios-preload"></div>

<div data-control="main-view" data-name="test-main" data-default="first" data-root="true">

	<div data-control="first-view" data-name="first">
	
		<div class="ios-ui-navigation-bar">
						
			<div class="title">My Contacts</div>
						
		</div>
		
		<div data-control="ios-ui-search-bar" data-name="search">
			<input type="text" name="search" autocomplete="false" spellcheck="false" placeholder="Search" />
			<div class="ios-ui-search-button">Cancel</div>
		</div>
		
		<div data-control="ios-ui-table-view" data-name="contacts-table">
			
			<ul>
				
				<li itemscope>
					<span itemprop="firstName"></span>
					<span itemprop="lastName"></span>
				</li>
				
			</ul>
		
		</div>
	
	</div>
	
	<div data-control="second-view" data-name="second">
		
		<div class="ios-ui-navigation-bar">
			
			<div class="ios-ui-bar-button-item left back" data-name="back-btn">Back</div>
			
			<div class="title">
				<span itemprop="firstName"></span> <span itemprop="lastName"></span>
			</div>
						
			<div class="ios-ui-bar-button-item right blue">Save</div>
			
		</div>
		
		
		<div class="ios-ui-table-form grouped sectioned">
				
			<div data-control="ios-ui-scroll-view" data-name="contact-info-scroller">
				
				<div class="section">Personal Information</div>
				
				<ul>
					
					<li>
						<div class="title">First Name</div>
						<div class="subtitle" itemprop="firstName"></div>
					</li>
					
					<li>
						<div class="title">Last Name</div>
						<div class="subtitle" itemprop="lastName"></div>
					</li>
					
					<li>
						<div class="title">Email</div>
						<div class="subtitle" itemprop="email"></div>
					</li>
					
					<li>
						<div class="title">Phone</div>
						<div class="subtitle" itemprop="phone"></div>
					</li>
				
				</ul>
				
				<div class="section">Other Information</div>
				
				<ul>
					
					<li>
						<div class="title">Birthday</div>
						<div class="subtitle" itemprop="birthday"></div>
					</li>
					
					<li>
						<div class="title">Website</div>
						<div class="subtitle" itemprop="website"></div>
					</li>
					
				</ul>
			
			</div>
		
		</div>
		
	</div>

</div>

</body>